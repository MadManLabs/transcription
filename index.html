<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Live Transcript</title>
	<style>
		* {
			box-sizing: border-box
		}

		body {
			font-family: sans-serif;
			margin: 0;
			padding: 0;
      scroll-behavior: smooth;
		}

    

		header, .header-buffer {
			background-color: #fff;
			position: fixed;
			width: 100%;
			top: 0;
			background-color: aliceblue;
			padding: 10px;
		}

    .header-buffer {
      position: initial
    }

		h1 {
			margin: 2px;
		}

		main {
			/* margin-top: 80px; */
			align-items: top;
		}

		p {
			font-size: 30px;
			line-height: 1.2;
			white-space: pre-wrap;
			outline: none;
      margin: 2px;
      margin-bottom: 62px;
		}

		section {
			padding: 10px;
		}

		.interim {
      font-size: 22px;
      color: #555;
      bottom: 0;
      left: 0;
      background-color: #FFF;
      padding: 8px;
      width: 100%;
      border-top: 1px solid gray;
      position: fixed;
		}

		.credit {
      margin-top: 4px;
			font-size: 12px;
			color:#333;
      display: block;
		}

    .snippet {
      margin: .15em;
      outline: none;
      display: inline-block;
    }

    .name-transcript {
      font-size: 14px;
    }
    
    .transcript-id-form {
      margin-top: 6px;
    }
	</style>
</head>

<body>
	<header>
    <h1>Live Transcript</h1>
		<button onclick="listen()">Start Listening</button>
    <button onclick="stop()">Stop Listening</button> Status: <span id="status">Not Listening</span>
    <form id="transcriptIDForm" class="transcript-id-form">
      <label>Transcript name (letters, numbers, and dashes only):
        <input type="text" id="newTranscriptID" pattern="[a-zA-Z0-9-]+">
      </label>
      <button type="submit">Name Transcript</button>
    </form>
  </header>
    <div class='header-buffer' aria-hidden="true">
      <h1>Live Transcript</h1>
      <button onclick="listen()">Start Listening</button>
      <button onclick="stop()">Stop Listening</button> Status:
      <span id="status">Not Listening</span>
      <form id="header-form-buffer" class="transcript-id-form">
        <label>Transcript name (letters, numbers, and dashes only):
          <input type="text" id="newTranscriptID" pattern="[a-zA-Z0-9-]+">
        </label>
        <button type="submit">Name Transcript</button>
      </form>
    </div>
	<main>
      
		<section>
      <span class="credit">Made by Mark Noonan (
        <a href="https://twitter.com/marktnoonan">@marktnoonan</a>), based on David Walsh's
        <a href="https://davidwalsh.name/speech-recognition">blog post</a>, and with apologies for only working in Google Chrome.</span>
      <hr>
      <aside class="name-transcript" id="name-transcript">
        You can name this transcript to save the results and allow others to access it live from their own devices. Or don't name
        it, and keep it private to just this browser window. If the transcript is not named, everything will be deleted when you
        close the page.
        <hr> 
      </aside>
			<p id="transcript" contenteditable="false"></p>
			<span class="interim" id="interim"></span>
		</section>
	</main>


<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase.js"></script>
<script>window.noZensmooth = true</script>
<script src="zenscroll-min.js"></script>
	<script>

  var config = {
		apiKey: "AIzaSyD591s8Of9vqduC2ZAakt9mMQRin4wCFSQ",
		authDomain: "live-transcript.firebaseapp.com",
		databaseURL: "https://live-transcript.firebaseio.com",
		projectId: "live-transcript",
		storageBucket: "",
		messagingSenderId: "1024703297861"
	};

  var database;
  var transcript = document.querySelector('#transcript')
  var transcriptID = '';
  var snippetIDs = [];
  var listening = false;
  var wordsPushedToTranscript = 0;
  var charLengthOfPushes = 0;
  var line;
  var lastResultCache = "";
  var observeLinkRoot = 'https://markthomasnoonan.com/transcription/observe.html'

  document.getElementById("transcriptIDForm").addEventListener('submit', function (event) {
        event.preventDefault();
        saveTranscriptID();
      })

  var recognition = new(window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
  recognition.lang = 'en-US';
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;
  var interim = document.querySelector('#interim');
  recognition.onresult = function(event) {
    var resultText = event.results[0][0].transcript;
    var resultWords = resultText.split(' ');
    var minLengthNeeded = 10 + wordsPushedToTranscript;


    if (resultWords.length > minLengthNeeded) {
      var wordsToPush = [];      
      for (var i = wordsPushedToTranscript; i < wordsPushedToTranscript + 5; i++) {
        console.log(i, resultWords[i]);
        
        wordsToPush.push(resultWords[i]);
      }
      pushWordsToTranscript(wordsToPush);
        wordsPushedToTranscript += 5;
      
      charLengthOfPushes += wordsToPush.join(' ').length;
      console.log(wordsPushedToTranscript, charLengthOfPushes); 
      console.log(resultText);           
    }
    if (charLengthOfPushes){
      // the math here is to include the correct number of spaces in what we are removing from the
      // beginning of the string. The goal is to not have the bottom fill up with text, obscuring the main
      // part of the screen but also forcing people who are watching the the stream to wait for 
      // a pause so that the transcript can catch up.
      console.log(wordsPushedToTranscript / 5);
      console.log(resultText);           
      interim.textContent = resultText.substring(charLengthOfPushes + (wordsPushedToTranscript / 5));  
      lastResultCache = resultText.substring(charLengthOfPushes + (wordsPushedToTranscript / 5));
      console.log(interim.textContent);
      
    } else {
      interim.textContent = resultText;     
      lastResultCache = resultText;
    }
    zenscroll.toY(document.body.scrollHeight, 1000);

  };

  recognition.onend = function(event) {
    
    if (lastResultCache != '') {
      var words = lastResultCache.split(" ");
      var numWords = words.length;
      line = document.createElement('div');
      for (var i = 0; i < words.length; i++ ){
        var snippetID = "snippet" + Date.now() + "-" + i;
        var span = document.createElement('span');
        span.className = "snippet";
        span.id = snippetID;
        span.setAttribute('contenteditable', 'true');
        span.append(words[i]);
        line.appendChild(span);
        if (transcriptID !== '') {
          snippetIDs.push(snippetID);
          database.ref('transcripts/' + transcriptID + '/' + snippetID).set(words[i], completion);
        }
        addEditingListener(snippetID, span);
        }
      transcript.appendChild(line);
      interim.textContent = '';
      lastResultCache = "";
      wordsPushedToTranscript = 0;
      charLengthOfPushes = 0;
    }

    if (listening === false) {
      return
    } else {
      zenscroll.toY(document.body.scrollHeight, 2000);
      recognition.start();
    }
  }

  function listen() {
    listening = true
    document.querySelector("#status").textContent = "Listening";
    recognition.start();
  }

  function stop() {
    recognition.stop();
    document.querySelector("#status").textContent = "Not Listening";
    interim.textContent = '';
    listening = false;
  }

  function pushWordsToTranscript(arrayOfWords) {
    console.log("will push this: ", arrayOfWords)
    for (var i = 0; i < arrayOfWords.length; i++) {
      var snippetID = "snippet" + Date.now() + "-" + i;
      var span = document.createElement('span');
      span.className = "snippet";
      span.id = snippetID;
      span.setAttribute('contenteditable', 'true');
      span.append(arrayOfWords[i]);
      if (transcriptID !== '') {
        snippetIDs.push(snippetID);
        database.ref('transcripts/' + transcriptID + '/' + snippetID).set(arrayOfWords[i], completion);
      }
      addEditingListener(snippetID, span);
      transcript.appendChild(span);
    }
  }

  function saveTranscriptID(){
    
    firebase.initializeApp(config); 
    database = firebase.database();
    
    transcriptID = document.getElementById("newTranscriptID").value;
    var observeLink = observeLinkRoot + "?" + transcriptID;
    document.getElementById('name-transcript').innerHTML = "";
    document.getElementById('transcriptIDForm').innerHTML='Link for others to watch: <a href="' 
      + observeLink + '" target="_blank">' + observeLink + '</a>';
    document.getElementById('header-form-buffer').innerHTML = 'Link for others to watch: <a href="'
      + observeLink + '" target="_blank">' + observeLink + '</a>';
    
  }

function addEditingListener(editedID, newElement){
  var textChanged = false;
  var blurListenerAdded = false;
  var element = newElement;
  //document.getElementById(editedID);
  element.addEventListener('click', selectWord);
  element.addEventListener('focus', selectWord);

  element.addEventListener('keydown', function(e){

  // esc and enter should confirm the edited word
  if (e.keyCode == 27) {
      element.blur();
      window.getSelection().removeAllRanges()
    } else if (e.keyCode == 13) {
      element.blur();
      e.preventDefault();
      window.getSelection().removeAllRanges()
    }

    if (!textChanged && e.keyCode == 9 || 
    !textChanged && e.shiftKey && e.keyCode == 9){
      // do nothing - there must be a better way to express this!
      } 
        else if (!blurListenerAdded && transcriptID !== '') {
        textChanged = true;
        blurListenerAdded = true;
        addBlurListener();
      }
  })

  function addBlurListener() {
    element.addEventListener('blur', function (e) {
    var newText = element.textContent;
    database.ref('transcripts/' + transcriptID + '/' + editedID).set(newText, completion);
    database.ref('transcripts/' + transcriptID + '/just-updated').set(editedID, completion);
    })
  }

  function selectWord () {
    var range, selection;
    if (window.getSelection && document.createRange) {
      selection = window.getSelection();
      range = document.createRange();
      range.selectNodeContents(this);
      selection.removeAllRanges();
      selection.addRange(range);
    } else if (document.selection && document.body.createTextRange) {
      range = document.body.createTextRange();
      range.moveToElementText(this);
      range.select();
    }
  }

}

function completion(error) {
  console.log('completed');
    if (error) {
      console.log("Data could not be saved." + error);
    } else {
      console.log("Data saved successfully.");
    }
  }

	</script>
</body>

</html>