<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Speech To Text</title>
	<style>
		* {
			box-sizing: border-box
		}

		body {
			font-family: sans-serif;
			margin: 0;
			padding: 0;
		}

		header {
			background-color: #fff;
			position: fixed;
			width: 100%;
			top: 0;
			background-color: aliceblue;
			padding: 10px;
		}

		h1 {
			margin: 2px;
		}

		main {
			margin-top: 80px;
			align-items: top;
		}

		p {
			font-size: 30px;
			line-height: 1.2;
			white-space: pre-wrap;
			outline: none;
		}

		section {
			padding: 10px;
		}

		.interim {
			font-size: 20px;
			color: slategray
		}

		.credit {
			font-size: 12px;
			color:#333;
		}

    .snippet {
      display: block;
    }

    .name-transcript {
      margin-top: 120px;
    }
	</style>
</head>

<body>
	<header>
    <h1>Live Transcript</h1>
		<button onclick="listen()">Start Listening</button>
    <button onclick="stop()">Stop Listening</button> Status: <span id="status">Not Listening</span>
    
		<span class="credit">Made by Mark Noonan (<a href="https://twitter.com/marktnoonan">@marktnoonan</a>), based on David Walsh's <a href="https://davidwalsh.name/speech-recognition">blog post</a>, and with apologies for only working in Google Chrome.</span>
  </header>
	<main>
      <aside class="name-transcript">
        Hi! You can name this transcript to save the results and allow others to access it live from their own devices. Or don't
        name it, and keep it private to just this browser window. Everything will be deleted when you close the page.
        <form id="transcriptIDForm">
          <label>Transcript ID:
            <input type="text" id="newTranscriptID">
          </label>
          <button type="submit">Name Transcript</button>
        </form>
      </aside>
		<section>
			<p id="transcript" contenteditable="false"></p>
			<span class="interim" id="interim"></span>
		</section>
	</main>


<script src="https://www.gstatic.com/firebasejs/4.8.2/firebase.js"></script>

	<script>
  var config = {
		apiKey: "AIzaSyD591s8Of9vqduC2ZAakt9mMQRin4wCFSQ",
		authDomain: "live-transcript.firebaseapp.com",
		databaseURL: "https://live-transcript.firebaseio.com",
		projectId: "live-transcript",
		storageBucket: "",
		messagingSenderId: "1024703297861"
	};
	firebase.initializeApp(config);
  var database = firebase.database();
  var transcript = document.querySelector('#transcript')
  var transcriptID = '';
  var snippetIDs = [];
  var listening = false;
  var lastResultCache = "";

  document.getElementById("transcriptIDForm").addEventListener('submit', function (event) {
        event.preventDefault();
        saveTranscriptID();
      })


  var recognition = new(window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
  recognition.lang = 'en-US';
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;
  recognition.onresult = function(event) {
    var interim = document.querySelector('#interim');
    interim.textContent = event.results[0][0].transcript
    lastResultCache = event.results[0][0].transcript
  };

  recognition.onend = function(event) {
    
    if (lastResultCache != '') {
      var snippetID = Date.now();
      var span = document.createElement('span');
      span.className = "snippet";
      span.id = snippetID;
      span.setAttribute('contenteditable', 'true');
      var snippetText = document.createTextNode(lastResultCache);
      span.append(lastResultCache);
      transcript.appendChild(span);
      
      if (transcriptID !== '') {
        snippetIDs.push(snippetID);
        database.ref('transcripts/' + transcriptID + '/' + snippetID).set(lastResultCache, completion);
      }

      lastResultCache = "";      
      addEditingListener(snippetID);
              
    }

    if (listening === false) {
      return
    } else {
      window.scrollTo(0, document.body.scrollHeight);
      recognition.start();
    }
  }

  function listen() {
    listening = true
    document.querySelector("#status").textContent = "Listening";
    recognition.start();
  }

  function stop() {
    recognition.stop();
    document.querySelector("#status").textContent = "Not Listening";
    listening = false;
  }

  function saveTranscriptID(){
    transcriptID = document.getElementById("newTranscriptID").value;
  }

function addEditingListener(editedID){
  var element = document.getElementById(editedID);
    element.addEventListener('keyup', function (e) {
    var newText = element.textContent;
    database.ref('transcripts/' + transcriptID + '/' + editedID).set(newText, completion);
    database.ref('transcripts/' + transcriptID + '/just-updated').set(editedID, completion);
  })
}

function completion(error) {
  console.log('completed');
    if (error) {
      console.log("Data could not be saved." + error);
    } else {
      console.log("Data saved successfully.");
    }
  }

	</script>
</body>

</html>